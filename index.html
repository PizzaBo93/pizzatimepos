<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒê∆°n h√†ng Pizza</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .login-box h1 {
      margin-bottom: 30px;
      color: #e74c3c;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #e74c3c;
    }

    button {
      background: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #c0392b;
    }

    .main-app {
      display: none;
    }

    .header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .store-badge {
      background: #e74c3c;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
    }

    .logout-btn {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #7f8c8d;
    }

    .tabs {
      background: white;
      display: flex;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      transition: all 0.3s;
    }

    .tab.active {
      color: #e74c3c;
      border-bottom: 3px solid #e74c3c;
    }

    .tab-content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    .order-form {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .menu-items {
      margin-top: 20px;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .menu-item:hover {
      background: #f9f9f9;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qty-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qty-btn:hover {
      background: #c0392b;
    }

    .order-summary {
      margin-top: 20px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .total-row {
      font-size: 18px;
      font-weight: 700;
      color: #e74c3c;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .order-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .order-type {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .type-dine { background: #3498db; color: white; }
    .type-takeout { background: #2ecc71; color: white; }
    .type-grab { background: #00b14f; color: white; }
    .type-shopee { background: #ee4d2d; color: white; }

    .table-select {
      margin-top: 10px;
    }

    .category-section {
      margin-bottom: 20px;
    }

    .category-header {
      background: #e74c3c;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }

    .category-header:hover {
      background: #c0392b;
    }

    .category-header.active {
      border-radius: 8px 8px 0 0;
    }

    .category-items {
      display: none;
      background: white;
      border: 2px solid #e74c3c;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 10px;
    }

    .category-items.show {
      display: block;
    }

    .category-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .category-icon.rotate {
      transform: rotate(180deg);
    }

    .order-items {
      margin: 15px 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .payment-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .payment-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .pay-cash {
      background: #27ae60;
      color: white;
    }

    .pay-transfer {
      background: #3498db;
      color: white;
    }

    .pay-app {
      background: #f39c12;
      color: white;
    }

    .report-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .report-section h2 {
      margin-bottom: 20px;
      color: #e74c3c;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #e74c3c;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #777;
      font-size: 14px;
    }

    .cash-register {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    .cash-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .cash-input-group input {
      flex: 1;
    }

    .cash-info {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: white;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .submit-btn {
      background: #27ae60;
      margin-top: 20px;
    }

    .submit-btn:hover {
      background: #229954;
    }

    .reset-btn {
      background: #e74c3c;
      margin-top: 10px;
    }

    .reset-btn:hover {
      background: #c0392b;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

            /* Th√™m v√†o ph·∫ßn <style> */
        .menu-item, .order-card, .category-items {
            will-change: transform;
            contain: layout style paint;
        }

        .category-items {
            transition: none; /* B·ªè transition n·∫øu c√≥ */
        }

        .report-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  margin-bottom: 15px;
  overflow: hidden;
}

.report-header {
  background: #e74c3c;
  color: white;
  padding: 15px 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.3s;
}

.report-header:hover {
  background: #c0392b;
}

.report-content {
  display: none;
  padding: 20px;
}

.report-content.show {
  display: block;
}

.report-icon {
  font-size: 20px;
  transition: transform 0.3s;
}

.report-icon.rotate {
  transform: rotate(180deg);
}
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üçï Pizza Manager</h1>
      <div class="form-group">
        <label>ID ƒêƒÉng nh·∫≠p</label>
        <input type="text" id="userId" placeholder="Nh·∫≠p ID c·ªßa b·∫°n">
      </div>
      <div class="form-group">
        <label>Ch·ªçn Qu√°n</label>
        <select id="storeSelect">
          <option value="">-- Ch·ªçn qu√°n --</option>
          <option value="DH">ƒê√† N·∫µng (DH)</option>
          <option value="NH">Nha Trang (NH)</option>
          <option value="HXH">H·ªì Xu√¢n H∆∞∆°ng (HXH)</option>
          <option value="PY">Ph√∫ Y√™n (PY)</option>
        </select>
      </div>
      <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="main-app" id="mainApp">
    <div class="header">
      <div class="header-info">
        <h2>üçï Pizza Manager</h2>
        <span class="store-badge" id="storeBadge"></span>
        <span id="userDisplay"></span>
      </div>
      <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab(0)">Nh·∫≠p ƒê∆°n H√†ng</div>
      <div class="tab" onclick="switchTab(1)">ƒê∆°n Hi·ªán T·∫°i</div>
      <div class="tab" onclick="switchTab(2)">B√°o C√°o</div>
    </div>

    <!-- Tab 1: New Order -->
    <div class="tab-content active" id="tab1">
      <div class="order-form">
        <h2>T·∫°o ƒê∆°n H√†ng M·ªõi</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Lo·∫°i ƒë∆°n h√†ng</label>
            <select id="orderType" onchange="toggleTableSelect()">
              <option value="dine">ƒÇn t·∫°i qu√°n</option>
              <option value="takeout">Mang v·ªÅ</option>
              <option value="grab">Grab</option>
              <option value="shopee">Shopee</option>
            </select>
            <div class="table-select" id="tableSelect">
              <label style="margin-top: 10px;">Ch·ªçn b√†n</label>
              <select id="tableNumber">
                <option value="1">B√†n 1</option>
                <option value="2">B√†n 2</option>
                <option value="3">B√†n 3</option>
                <option value="4">B√†n 4</option>
                <option value="5">B√†n 5</option>
                <option value="6">B√†n 6</option>
                <option value="7">B√†n 7</option>
                <option value="8">B√†n 8</option>
                <option value="9">B√†n 9</option>
                <option value="10">B√†n 10</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ghi ch√∫</label>
            <input type="text" id="orderNote" placeholder="Ghi ch√∫ ƒë∆°n h√†ng">
          </div>
        </div>

        <h3>Ch·ªçn m√≥n</h3>
        <div id="menuCategories"></div>

        <div class="order-summary">
          <div id="orderSummaryItems"></div>
          <div class="summary-row total-row">
            <span>T·ªîNG C·ªòNG:</span>
            <span id="totalAmount">0ƒë</span>
          </div>
        </div>

        <button class="submit-btn" onclick="createOrder()">T·∫°o ƒê∆°n H√†ng</button>
      </div>
    </div>

    <!-- Tab 2: Current Orders -->
    <div class="tab-content" id="tab2">
      <h2>ƒê∆°n H√†ng Hi·ªán T·∫°i</h2>
      <div class="orders-grid" id="ordersGrid"></div>
    </div>

    <!-- Tab 3: Reports -->
<div class="tab-content" id="tab3">
  <!-- Card 1: Doanh Thu -->
  <div class="report-card">
    <div class="report-header" onclick="toggleReport('revenue')">
      <span>üí∞ Doanh Thu H√¥m Nay</span>
      <span class="report-icon" id="icon-revenue">‚ñº</span>
    </div>
    <div class="report-content" id="content-revenue">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalRevenue">0ƒë</div>
          <div class="stat-label">T·ªïng doanh thu</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="dineRevenue">0ƒë</div>
          <div class="stat-label">Ti·ªÅn m·∫∑t</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="takeoutRevenue">0ƒë</div>
          <div class="stat-label">Chuy·ªÉn kho·∫£n</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="appRevenue">0ƒë</div>
          <div class="stat-label">Grab + Shopee</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card 2: M√≥n ƒê√£ B√°n -->
  <div class="report-card">
    <div class="report-header" onclick="toggleReport('items')">
      <span>üçï M√≥n ƒê√£ B√°n</span>
      <span class="report-icon" id="icon-items">‚ñº</span>
    </div>
    <div class="report-content" id="content-items">
      <div id="soldItems"></div>
    </div>
  </div>

  <!-- Card 3: Qu·∫£n L√Ω K√©t Ti·ªÅn -->
  <div class="report-card">
    <div class="report-header" onclick="toggleReport('cash')">
      <span>üíµ Qu·∫£n L√Ω K√©t Ti·ªÅn</span>
      <span class="report-icon" id="icon-cash">‚ñº</span>
    </div>
    <div class="report-content" id="content-cash">
      <div class="cash-register">
        <div class="cash-input-group">
          <input type="number" id="startCash" placeholder="Nh·∫≠p ti·ªÅn ƒë·∫ßu ng√†y">
          <button onclick="setStartCash()">C·∫≠p nh·∫≠t</button>
        </div>
        <div class="cash-info">
          <span>Ti·ªÅn ƒë·∫ßu ng√†y:</span>
          <strong id="displayStartCash">0ƒë</strong>
        </div>
        <div class="cash-info">
          <span>Doanh thu trong ng√†y:</span>
          <strong id="displayRevenue">0ƒë</strong>
        </div>
        <div class="cash-info">
          <span>T·ªïng k√©t ti·ªÅn:</span>
          <strong id="displayTotalCash">0ƒë</strong>
        </div>
        <button class="reset-btn" onclick="resetCashRegister()">Ch·ªët K√©t & Reset</button>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const menuData = {
            'Pizza': [
            { id: 'p1', name: 'B√≤ (Size S)', price: 39000 },
            { id: 'p2', name: 'Ph√¥ mai (Size S)', price: 39000 },
            { id: 'p3', name: 'G√† teriyaki (Size S)', price: 39000 },
            { id: 'p4', name: 'X√∫c x√≠ch heo (Size S)', price: 39000 },
            { id: 'p5', name: 'C√° ng·ª´ (Size S)', price: 39000 },
            { id: 'p6', name: 'Ba r·ªçi x√¥ng kh√≥i (Size S)', price: 39000 },

            { id: 'p7', name: 'B√≤ (Size L)', price: 89000 },
            { id: 'p8', name: 'Ph√¥ mai (Size L)', price: 89000 },
            { id: 'p9', name: 'G√† teriyaki (Size L)', price: 89000 },
            { id: 'p10', name: 'H·∫£i s·∫£n (Size L)', price: 89000 },
            { id: 'p11', name: 'X√∫c x√≠ch heo (Size L)', price: 89000 },
            { id: 'p12', name: 'Pizza n·∫•m rau c·ªß (Size L)', price: 89000 },
            { id: 'p13', name: 'X√∫c x√≠ch ƒê·ª©c (Size L)', price: 89000 },
            { id: 'p14', name: 'C√° ng·ª´ (Size L)', price: 89000 },
            { id: 'p15', name: 'Ba r·ªçi x√¥ng kh√≥i (Size L)', price: 89000 },
            { id: 'p16', name: 'Salami (Size L)', price: 109000 },
            { id: 'p17', name: 'Ph√¥ mai t∆∞∆°i (Size L)', price: 99000 },
            { id: 'p18', name: "Meat Lover's (Size L)", price: 109000 },
            { id: 'p19', name: 'T√¥m thanh cua (Size L)', price: 99000 },
            { id: 'p20', name: 'Kh√¥ G√† - L·∫°p X∆∞·ªüng (Size L)', price: 99000 },
            { id: 'p21', name: 'Th·∫≠p C·∫©m (Size L)', price: 109000 },
            { id: 'p22', name: 'B√≤ s·ªët cay (Size L)', price: 109000 },
            { id: 'p23', name: 'H·∫£i s·∫£n ƒë·∫∑c bi·ªát (Size L)', price: 99000 }
        ],

        'M√≥n ƒÇn Nh·∫π': [
            { id: 's1', name: 'G√† S·ªët Cay', price: 29000 },
            { id: 's2', name: 'Khoai t√¢y chi√™n (nh·ªè)', price: 15000 },
            { id: 's3', name: 'Khoai t√¢y chi√™n (l·ªõn)', price: 25000 },
            { id: 's4', name: 'Tok L·∫Øc Ph√¥ Mai', price: 15000 },
            { id: 's5', name: 'B√°nh M√¨ B∆° T·ªèi', price: 15000 },
            { id: 's6', name: 'G√† l·∫Øc ph√¥ mai cay (nh·ªè)', price: 25000 },
            { id: 's7', name: 'G√† l·∫Øc ph√¥ mai cay (l·ªõn)', price: 35000 },
            { id: 's8', name: 'G√† r√°n chi√™n gi√≤n (nh·ªè)', price: 25000 },
            { id: 's9', name: 'G√† r√°n chi√™n gi√≤n (l·ªõn)', price: 30000 },
            { id: 's10', name: 'M√¨ √ù ƒë√∫t l√≤', price: 59000 },
            { id: 's11', name: 'M√¨ √ù s·ªët b√≤ b·∫±m', price: 39000 },
            { id: 's12', name: 'Salad C√° Ng·ª´', price: 39000 },
            { id: 's13', name: 'Salad d·∫ßu gi·∫•m', price: 29000 },
            { id: 's14', name: 'B√°nh m√¨ ph√¥ mai', price: 25000 },
            { id: 's15', name: 'B·∫Øp Ph√¥ Mai', price: 29000 }
        ],

        'N∆∞·ªõc': [
            { id: 'd1', name: 'N∆∞·ªõc ng·ªçt (ly)', price: 9000 },
            { id: 'd2', name: 'N∆∞·ªõc ng·ªçt (lon)', price: 15000 },
            { id: 'd3', name: 'N∆∞·ªõc su·ªëi', price: 9000 },
            { id: 'd4', name: 'Local Beer', price: 15000 },
            { id: 'd5', name: 'ƒê√° me h·∫°t m·ªÅm', price: 15000 },
            { id: 'd6', name: 'Tr√† Chanh', price: 15000 },
            { id: 'd7', name: 'Tr√† ƒê√†o', price: 20000 },
            { id: 'd8', name: 'Tr√† s·ªØa Th√°i', price: 20000 }
        ],

      'Combo': [
            { id: 'c1', name: 'Combo 1 (1 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 2 n∆∞·ªõc ng·ªçt)', price: 119000 },

            { id: 'c2', name: 'Combo 2 (1 Pizza b·∫•t k·ª≥ + 3 g√† r√°n + 3 n∆∞·ªõc ng·ªçt)', price: 179000 },

            { id: 'c3', name: 'Combo 3 (2 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 1 khoai t√¢y chi√™n + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },

            { id: 'c4', name: 'Combo 4 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 n∆∞·ªõc ng·ªçt)', price: 139000 },

            { id: 'c5', name: 'Combo 5 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 m√¨ √ù + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },

            { id: 'c6', name: 'Combo 6 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 1 m√¨ √ù + 2 n∆∞·ªõc ng·ªçt)', price: 159000 },

            { id: 'c7', name: 'Combo 7 (1 Pizza size S b·∫•t k·ª≥ + 1 n∆∞·ªõc ng·ªçt)', price: 45000 },

            { id: 'c8', name: 'Combo 8 (1 Pizza size S b·∫•t k·ª≥ + 1 khoai t√¢y chi√™n + 1 n∆∞·ªõc ng·ªçt)', price: 59000 }
            ]
    };

    // Th√™m v√†o ƒë·∫ßu ph·∫ßn <script>, sau khai b√°o menuData
    const SUPABASE_URL = 'https://mhmvtywqtaqikaubhhmf.supabase.co'; // Thay b·∫±ng URL c·ªßa b·∫°n
    const SUPABASE_ANON_KEY = 'sb_publishable_lTDNdWmRZaO2VF-oCs2zvg_7NSzJpCa'; // Thay b·∫±ng anon key c·ªßa b·∫°n
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = '';
    let currentStore = '';
    let orders = [];
    let cart = {};
    let dailyReport = {
      revenue: { total: 0, dine: 0, takeout: 0, app: 0 },
      items: {},
      cash: { start: 0, current: 0 }
    };

    const itemCache = {};

    function initItemCache() {
        Object.keys(menuData).forEach(category => {
            menuData[category].forEach(item => {
                itemCache[item.id] = item;
            });
        });
    }

    function findItemById(itemId) {
        return itemCache[itemId] || null;
    }

    // G·ªçi trong h√†m login
async function login() {
    const userId = document.getElementById('userId').value.trim();
    const store = document.getElementById('storeSelect').value;

    if (!userId || !store) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }

    currentUser = userId;
    currentStore = store;

    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('storeBadge').textContent = store;
    document.getElementById('userDisplay').textContent = `User: ${userId}`;

    initItemCache(); // Kh·ªüi t·∫°o cache
    await loadData();
    renderMenu();
    toggleTableSelect();
    updateReports();
}

    function toggleTableSelect() {
      const orderType = document.getElementById('orderType').value;
      const tableSelect = document.getElementById('tableSelect');
      tableSelect.style.display = orderType === 'dine' ? 'block' : 'none';
    }

    function logout() {
      saveData();
      currentUser = '';
      currentStore = '';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('userId').value = '';
      document.getElementById('storeSelect').value = '';
    }

    function switchTab(index) {
      document.querySelectorAll('.tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
      });
      document.querySelectorAll('.tab-content').forEach((content, i) => {
        content.classList.toggle('active', i === index);
      });

      if (index === 1) renderOrders();
      if (index === 2) updateReports();
    }

    function toggleCategory(category) {
    const items = document.getElementById(`items-${category}`);
    const icon = document.getElementById(`icon-${category}`);
    const header = document.getElementById(`header-${category}`);
    
    const isShowing = items.classList.contains('show');
    
    if (!isShowing && items.innerHTML.trim() === '') {
        // Ch·ªâ render items l·∫ßn ƒë·∫ßu ti√™n khi m·ªü
        renderCategoryItems(category);
    }
    
    items.classList.toggle('show');
    icon.classList.toggle('rotate');
    header.classList.toggle('active');
}

    function renderMenu() {
    const container = document.getElementById('menuCategories');
    
    container.innerHTML = Object.keys(menuData).map(category => {
        return `
        <div class="category-section">
            <div class="category-header" id="header-${category}" onclick="toggleCategory('${category}')">
                <span>üìÅ ${category}</span>
                <span class="category-icon" id="icon-${category}">‚ñº</span>
            </div>
            <div class="category-items" id="items-${category}">
                <!-- S·∫Ω render khi click v√†o category -->
            </div>
        </div>
        `;
    }).join('');
}

    let cartUpdateTimeout;

function updateCart(itemId, change) {
    if (!cart[itemId]) cart[itemId] = 0;
    cart[itemId] += change;
    if (cart[itemId] <= 0) delete cart[itemId];
    
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ngay l·∫≠p t·ª©c (kh√¥ng re-render)
    updateQuantityDisplay(itemId);
    
    // Debounce vi·ªác c·∫≠p nh·∫≠t summary
    clearTimeout(cartUpdateTimeout);
    cartUpdateTimeout = setTimeout(() => {
        updateOrderSummary();
    }, 150);
}

function updateQuantityDisplay(itemId) {
    // T√¨m v√† c·∫≠p nh·∫≠t ch·ªâ ph·∫ßn s·ªë l∆∞·ª£ng
    const quantitySpans = document.querySelectorAll(`[data-item-id="${itemId}"]`);
    quantitySpans.forEach(span => {
        span.textContent = cart[itemId] || 0;
    });
}
      
      updateOrderSummary();
    

    function renderCategoryItems(category) {
    const container = document.getElementById(`items-${category}`);
    if (!container) return;

    const items = menuData[category].map(item => {
        const displayName = item.size ? `${item.name} (${item.size})` : item.name;
        
        return `
            <div class="menu-item">
                <div>
                    <strong>${displayName}</strong>
                    <div style="color: #e74c3c; font-weight: 600;">${formatMoney(item.price)}</div>
                </div>
                <div class="quantity-control">
                    <button class="qty-btn" onclick="updateCart('${item.id}', -1)">-</button>
                    <span data-item-id="${item.id}" style="min-width: 30px; text-align: center; font-weight: 600;">${cart[item.id] || 0}</span>
                    <button class="qty-btn" onclick="updateCart('${item.id}', 1)">+</button>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = items;
}


    function findItemById(itemId) {
      for (const category in menuData) {
        const item = menuData[category].find(i => i.id === itemId);
        if (item) return item;
      }
      return null;
    }

    function updateOrderSummary() {
    const summaryItems = document.getElementById('orderSummaryItems');
    const totalAmount = document.getElementById('totalAmount');

    let total = 0;
    const htmlParts = [];

    for (const itemId in cart) {
        const item = findItemById(itemId);
        if (!item) continue;
        
        const qty = cart[itemId];
        const subtotal = item.price * qty;
        total += subtotal;

        htmlParts.push(`
            <div class="summary-row">
                <span>${item.name} x ${qty}</span>
                <span>${formatMoney(subtotal)}</span>
            </div>
        `);
    }

    summaryItems.innerHTML = htmlParts.join('');
    totalAmount.textContent = formatMoney(total);
}

    async function createOrder() {
        if (Object.keys(cart).length === 0) {
            alert('Vui l√≤ng ch·ªçn m√≥n!');
            return;
        }

        const orderType = document.getElementById('orderType').value;
        const tableNumber = document.getElementById('tableNumber').value;

        const order = {
            id: Date.now(),
            store_code: currentStore,
            user_id: currentUser,
            order_type: orderType,
            table_number: orderType === 'dine' ? tableNumber : null,
            note: document.getElementById('orderNote').value,
            items: {...cart},
            total: Object.keys(cart).reduce((sum, id) => {
            const item = findItemById(id);
            return sum + (item.price * cart[id]);
            }, 0),
            status: 'pending',
            created_at: new Date().toISOString()
        };

        try {
            // L∆∞u v√†o Supabase
            const { error } = await supabase
            .from('orders')
            .insert([order]);

            if (error) throw error;

            orders.push(order);
            cart = {};
            document.getElementById('orderNote').value = '';
            renderMenu();
            updateOrderSummary();
            await saveData();
            alert('ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o!');
            switchTab(1);

        } catch (error) {
            console.error('L·ªói t·∫°o ƒë∆°n h√†ng:', error);
            alert('C√≥ l·ªói khi t·∫°o ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!');
        }
        }

    function renderOrders() {
    const grid = document.getElementById('ordersGrid');
    
    if (orders.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #999;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>';
        return;
    }

    // S·ª≠ d·ª•ng DocumentFragment ƒë·ªÉ t·ªëi ∆∞u DOM manipulation
    const fragment = document.createDocumentFragment();
    const tempDiv = document.createElement('div');
    
    tempDiv.innerHTML = orders.map(order => {
        let typeClass, typeLabel;
        
        switch(order.type || order.order_type) {
            case 'dine':
                typeClass = 'type-dine';
                typeLabel = 'ƒÇn t·∫°i qu√°n - B√†n ' + (order.table || order.table_number);
                break;
            case 'takeout':
                typeClass = 'type-takeout';
                typeLabel = 'Mang v·ªÅ';
                break;
            case 'grab':
                typeClass = 'type-grab';
                typeLabel = 'Grab';
                break;
            default:
                typeClass = 'type-shopee';
                typeLabel = 'Shopee';
        }

        const itemsHtml = Object.keys(order.items).map(itemId => {
            const item = findItemById(itemId);
            if (!item) return '';
            return `
                <div class="order-item">
                    <span>${item.name} x ${order.items[itemId]}</span>
                    <span>${formatMoney(item.price * order.items[itemId])}</span>
                </div>
            `;
        }).join('');

        return `
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <span class="order-type ${typeClass}">${typeLabel}</span>
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">${order.timestamp || new Date(order.created_at).toLocaleString('vi-VN')}</div>
                    </div>
                    <div style="font-size: 20px; font-weight: 700; color: #e74c3c;">
                        ${formatMoney(order.total)}
                    </div>
                </div>
                ${order.note ? `<div style="margin-bottom: 10px; font-style: italic; color: #777;">Ghi ch√∫: ${order.note}</div>` : ''}
                <div class="order-items">${itemsHtml}</div>
                <div class="payment-buttons">
                    <button class="payment-btn pay-cash" onclick="payOrder(${order.id}, 'cash')">Ti·ªÅn m·∫∑t</button>
                    <button class="payment-btn pay-transfer" onclick="payOrder(${order.id}, 'transfer')">Chuy·ªÉn kho·∫£n</button>
                    <button class="payment-btn pay-app" onclick="payOrder(${order.id}, 'grab')" style="background: #00b14f;">Grab</button>
                    <button class="payment-btn pay-app" onclick="payOrder(${order.id}, 'shopee')" style="background: #ee4d2d;">Shopee</button>
                </div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = tempDiv.innerHTML;
}

    async function payOrder(orderId, method) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;

        const methodLabel = method === 'cash' ? 'Ti·ªÅn m·∫∑t' : 
                            method === 'transfer' ? 'Chuy·ªÉn kho·∫£n' : 
                            method === 'grab' ? 'Grab' :
                            'Shopee';
        
        if (!confirm(`X√°c nh·∫≠n thanh to√°n ${formatMoney(order.total)} b·∫±ng ${methodLabel}?`)) {
            return;
        }

        try {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i order trong Supabase
            const { error } = await supabase
            .from('orders')
            .update({ 
                status: 'paid',
                payment_method: method 
            })
            .eq('id', orderId);

            if (error) throw error;

            // C·∫≠p nh·∫≠t b√°o c√°o theo ph∆∞∆°ng th·ª©c thanh to√°n
            dailyReport.revenue.total += order.total;
            dailyReport.revenue[method] += order.total;
            
            // Ch·ªâ c·ªông v√†o k√©t khi thanh to√°n ti·ªÅn m·∫∑t
            if (method === 'cash') {
                dailyReport.cash.current += order.total;
            }

            Object.keys(order.items).forEach(itemId => {
                const item = findItemById(itemId);
                if (!item) return;
                
                if (!dailyReport.items[item.name]) {
                    dailyReport.items[item.name] = 0;
                }
                dailyReport.items[item.name] += order.items[itemId];
            });

            orders = orders.filter(o => o.id !== orderId);
            await saveData();
            renderOrders();
            updateReports();
            alert('ƒê√£ thanh to√°n th√†nh c√¥ng!');

        } catch (error) {
            console.error('L·ªói thanh to√°n:', error);
            alert('C√≥ l·ªói khi thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i!');
        }
    }
    function updateReports() {
      document.getElementById('totalRevenue').textContent = formatMoney(dailyReport.revenue.total);
    document.getElementById('dineRevenue').textContent = formatMoney(dailyReport.revenue.cash || 0);
    document.getElementById('takeoutRevenue').textContent = formatMoney(dailyReport.revenue.transfer || 0);
    document.getElementById('appRevenue').textContent = formatMoney((dailyReport.revenue.grab || 0) + (dailyReport.revenue.shopee || 0));
      const soldItems = document.getElementById('soldItems');
      const itemsHtml = Object.keys(dailyReport.items).map(name => `
        <div class="order-item">
          <span>${name}</span>
          <strong>${dailyReport.items[name]} m√≥n</strong>
        </div>
      `).join('');
      soldItems.innerHTML = itemsHtml || '<p style="color: #999;">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c b√°n</p>';

      document.getElementById('displayStartCash').textContent = formatMoney(dailyReport.cash.start);
      document.getElementById('displayRevenue').textContent = formatMoney(dailyReport.revenue.total);
      document.getElementById('displayTotalCash').textContent = formatMoney(dailyReport.cash.start + dailyReport.cash.current);
    }

    function setStartCash() {
      const amount = parseInt(document.getElementById('startCash').value);
      if (isNaN(amount) || amount < 0) {
        alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
        return;
      }
      dailyReport.cash.start = amount;
      document.getElementById('startCash').value = '';
      saveData();
      updateReports();
      alert('ƒê√£ c·∫≠p nh·∫≠t ti·ªÅn ƒë·∫ßu ng√†y!');
    }

    function resetCashRegister() {
        if (!confirm('X√°c nh·∫≠n ch·ªët k√©t v√† reset d·ªØ li·ªáu ng√†y m·ªõi?')) return;

        const totalCash = dailyReport.cash.start + dailyReport.cash.current;
        alert(`T·ªïng k√©t ti·ªÅn: ${formatMoney(totalCash)}\n\nƒê√£ reset d·ªØ li·ªáu ng√†y m·ªõi!`);

        dailyReport = {
            revenue: { total: 0, cash: 0, transfer: 0, grab: 0, shopee: 0 },
            items: {},
            cash: { start: 0, current: 0 }
        };

        saveData();
        updateReports();
        }


    function formatMoney(amount) {
      return amount.toLocaleString('vi-VN') + 'ƒë';
    }

    function toggleReport(reportId) {
      const content = document.getElementById(`content-${reportId}`);
      const icon = document.getElementById(`icon-${reportId}`);
      
      content.classList.toggle('show');
      icon.classList.toggle('rotate');
    }

    async function saveData() {
        try {
            // L∆∞u daily report
            const { error: reportError } = await supabase
            .from('daily_reports')
            .upsert({
                store_code: currentStore,
                user_id: currentUser,
                report_date: new Date().toISOString().split('T')[0],
                revenue: dailyReport.revenue,
                items_sold: dailyReport.items,
                cash_register: dailyReport.cash,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'store_code,user_id,report_date'
            });

            if (reportError) throw reportError;

            // V·∫´n gi·ªØ localStorage ƒë·ªÉ backup
            const data = { orders, dailyReport, timestamp: Date.now() };
            const key = `pizza_${currentStore}_${currentUser}`;
            localStorage.setItem(key, JSON.stringify(data));

        } catch (error) {
            console.error('L·ªói l∆∞u d·ªØ li·ªáu:', error);
            alert('C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!');
        }
        }


    async function loadData() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            // Load daily report t·ª´ Supabase
            const { data: reportData, error } = await supabase
            .from('daily_reports')
            .select('*')
            .eq('store_code', currentStore)
            .eq('user_id', currentUser)
            .eq('report_date', today)
            .single();

            if (reportData && !error) {
            dailyReport = {
                revenue: reportData.revenue,
                items: reportData.items_sold,
                cash: reportData.cash_register
            };
            } else {
            // Kh·ªüi t·∫°o m·ªõi n·∫øu ch∆∞a c√≥
            dailyReport = {
                revenue: { total: 0, cash: 0, transfer: 0, grab: 0, shopee: 0 },
                items: {},
                cash: { start: 0, current: 0 }
                };
            }

            // Load orders t·ª´ Supabase (orders ch∆∞a thanh to√°n)
            const { data: ordersData, error: ordersError } = await supabase
            .from('orders')
            .select('*')
            .eq('store_code', currentStore)
            .eq('user_id', currentUser)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

            if (ordersData && !ordersError) {
            orders = ordersData;
            }

        } catch (error) {
            console.error('L·ªói load d·ªØ li·ªáu:', error);
            // Fallback v·ªÅ localStorage n·∫øu c√≥ l·ªói
            const key = `pizza_${currentStore}_${currentUser}`;
            const saved = localStorage.getItem(key);
            if (saved) {
            const data = JSON.parse(saved);
            orders = data.orders || [];
            dailyReport = data.dailyReport || {
                revenue: { total: 0, cash: 0, transfer: 0, grab: 0, shopee: 0 },
                items: {},
                cash: { start: 0, current: 0 }
                };
            }
        }
        }
  </script>
</body>
</html>
